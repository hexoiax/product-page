<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwCpEIrkWo_aDGQI3Tek6gKeg2VOTWASXDe59AMRK15kazytqIMrMMAmaYbZ9ynVYmsNA/exec';
const sizes=['36','37','38','39','40','41','42'];
const qtys=['1','2','3','4','5','6','7','8','9','10'];

const sizeContainer=document.getElementById('size-container');
const qtySelected=document.getElementById('qty-selected');
const qtyDropdown=document.getElementById('qty-dropdown');
const priceSummary=document.getElementById('price-summary');
const subtotalEl=document.getElementById('subtotal');
const discountEl=document.getElementById('discount');
const totalEl=document.getElementById('total');
const popup=document.getElementById('success-popup');
const submitBtn=document.getElementById('submit-btn');
const basePrice=162500;

let selectedSizes=[];
let selectedQty=null;

function vibe(ms=20){ if(navigator.vibrate) navigator.vibrate(ms); }

function animateValue(el,start,end,duration=500){
  const startTime=performance.now();
  function tick(now){
    const progress=Math.min((now-startTime)/duration,1);
    const value=Math.floor(start + (end-start)*progress);
    el.textContent=value.toLocaleString('vi-VN')+'₫';
    if(progress<1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

document.querySelectorAll("input, textarea").forEach(el=>{
  el.addEventListener("focus",()=> el.style.boxShadow="0 0 0 2px #2e7d32");
  el.addEventListener("blur",()=> el.style.boxShadow="none");
});

sizes.forEach(size=>{
  const chip=document.createElement('div');
  chip.textContent=size;
  chip.className='size-chip';

  chip.style.cssText=`
    padding:10px 16px; border-radius:10px; border:1px solid #ccc;
    cursor:pointer; user-select:none; transition:.15s;
  `;

  chip.addEventListener('click',()=>{
    vibe();
    if(selectedSizes.includes(size)){
      selectedSizes=selectedSizes.filter(s=>s!==size);
      chip.style.background='white';
      chip.style.color='black';
      chip.style.border='1px solid #ccc';
      chip.style.transform='scale(1)';
    } else {
      selectedSizes.push(size);
      chip.style.background='#2e7d32';
      chip.style.color='white';
      chip.style.border='1px solid #2e7d32';
      chip.style.transform='scale(1.12)';
      setTimeout(()=>chip.style.transform='scale(1)',120);
    }
  });

  sizeContainer.appendChild(chip);
});

qtys.forEach(qty=>{
  const item=document.createElement('div');
  item.textContent=qty;
  item.style.padding='10px 14px';
  item.style.cursor='pointer';
  item.style.borderBottom='1px solid #eee';
  item.style.transition="background .15s";

  item.addEventListener('mouseenter',()=>item.style.background='#f7f7f7');
  item.addEventListener('mouseleave',()=>item.style.background='white');

  item.addEventListener('click',()=>{
    vibe();
    selectedQty=parseInt(qty);
    qtySelected.textContent=`Số lượng: ${qty}`;
    qtyDropdown.style.maxHeight="0px";
    setTimeout(()=>qtyDropdown.style.display='none',200);
    updatePrice();
  });

  qtyDropdown.appendChild(item);
});

qtySelected.addEventListener('click',()=>{
  vibe();
  if(qtyDropdown.style.display==='block'){
    qtyDropdown.style.maxHeight="0px";
    setTimeout(()=>qtyDropdown.style.display='none',180);
  } else {
    qtyDropdown.style.display='block';
    requestAnimationFrame(()=> qtyDropdown.style.maxHeight="140px");
  }
});

document.addEventListener('click',(e)=>{
  if(!qtySelected.contains(e.target) && !qtyDropdown.contains(e.target)){
    qtyDropdown.style.maxHeight="0px";
    setTimeout(()=>qtyDropdown.style.display='none',180);
  }
});

function updatePrice(){
  if(!selectedQty) return;
  const subtotal=basePrice * selectedQty;
  const discount=subtotal * 0.2;
  const total=subtotal - discount;

  animateValue(subtotalEl,0,subtotal);
  animateValue(discountEl,0,-discount);
  animateValue(totalEl,0,total);

  priceSummary.style.display='block';
}

function showError(el,message){
  alert(message);
  el.focus();
  el.scrollIntoView({behavior:'smooth',block:'center'});
}

submitBtn.addEventListener('click',()=>{

  const name=document.getElementById('name');
  const phone=document.getElementById('phone');
  const address=document.getElementById('address');
  const note=document.getElementById('note');

  if(!name.value.trim()) return showError(name,'Vui lòng nhập tên');
  if(!phone.value.trim()) return showError(phone,'Vui lòng nhập số điện thoại');
  if(!address.value.trim()) return showError(address,'Vui lòng nhập địa chỉ');
  if(selectedSizes.length===0) return alert('Vui lòng chọn ít nhất 1 size');
  if(!selectedQty) return alert('Vui lòng chọn số lượng');

  vibe(40);

  submitBtn.disabled=true;
  submitBtn.style.opacity="0.7";
  submitBtn.textContent="Đang gửi...";

  popup.style.display='flex';
  popup.style.opacity='0';
  popup.style.transition='opacity .35s ease';

  setTimeout(()=> popup.style.opacity='1',20);

  fetch(SCRIPT_URL,{
    method:'POST',
    body:new URLSearchParams({
      name:name.value,
      phone:phone.value,
      address:address.value,
      sizes:selectedSizes.join(', '),
      quantity:selectedQty,
      note:note.value
    })
  });

  setTimeout(()=>{
    popup.style.opacity='0';
    setTimeout(()=> popup.style.display='none',300);

    submitBtn.disabled=false;
    submitBtn.style.opacity="1";
    submitBtn.textContent="Gửi đơn hàng";

    name.value=''; phone.value=''; address.value=''; note.value='';
    selectedSizes=[]; selectedQty=null;
    qtySelected.textContent='Chọn số lượng';
    priceSummary.style.display='none';

    document.querySelectorAll('.size-chip').forEach(chip=>{
      chip.style.background='white';
      chip.style.color='black';
      chip.style.border='1px solid #ccc';
    });

  },3000);
});
</script>
